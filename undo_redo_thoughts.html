<!DOCTYPE html>
<html>
  <head>
    <title>Basic undo/redo behaviour</title>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
  </head>

  <body>

    <p>Open the console!</p>

    <script type="text/javascript">
      // Undo Engine.
      //
      // Requires command objects with executeUndo() and executeRedo() functions.
      // Example of usage:
      // -----------------
      // UndoEngine.addCommand({executeUndo: function() {...}, executeRedo: function() {...}});
      // btnUndo.enabled = UndoEngine.canUndo();
      // btnRedo.enabled = UndoEngine.canRedo();
      // UndoEngine.addCommand({executeUndo: function() {...}, executeRedo: function() {...}});
      // UndoEngine.addCommand({executeUndo: function() {...}, executeRedo: function() {...}});
      // UndoEngine.undo();
      // UndoEngine.redo();
      var UndoEngine = (function () {
        "use strict";

        var returnObject = {};

        var undoStack = [];
        var undoIndex = -1;

        returnObject.canUndo = function() {
          return (undoStack.length > 0) && (undoIndex >= 0);
        };

        returnObject.canRedo = function() {
          return undoIndex < undoStack.length - 1;
        };

        // Add a command to the undo list and discard redos
        // beyond the current position if we've performed any.
        returnObject.addCommand = function(cmd) {
          undoIndex += 1;
          undoStack.splice(undoIndex);
          undoStack.push(cmd);
        };

        returnObject.undo = function() {
          if(!returnObject.canUndo()) {
            throw "ERROR: Cannot call undo at this time.";
          }
          var cmd = undoStack[undoIndex];
          cmd.executeUndo();
          undoIndex -= 1;
        };

        returnObject.redo = function() {
          if(!returnObject.canRedo()) {
            throw "ERROR: Cannot call redo at this time.";
          }
          var cmd = undoStack[undoIndex + 1];
          cmd.executeRedo();
          undoIndex += 1;
        };

        // JUST FOR DEMO PURPOSES.
        returnObject.listU = function() {
          return JSON.stringify(undoStack);
        };

        return returnObject;

      }());

      // DEMO:

      console.log("can-undo - N", UndoEngine.canUndo());
      console.log("can-redo - N", UndoEngine.canRedo());

      UndoEngine.addCommand({action: "new", object_definition: "{Konva Rect ...}", executeUndo() {console.log('undoing new'); }, executeRedo() { console.log('redo new'); } });
      console.log("ADDED");
      console.log("can-undo - Y", UndoEngine.canUndo());
      console.log("can-redo - N", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

      UndoEngine.addCommand({action: "move", object_definition: "{Konva Rect ...}", executeUndo() {console.log('undoing move'); }, executeRedo() { console.log('redo move'); } });
      console.log("MOVED");
      console.log("can-undo - Y", UndoEngine.canUndo());
      console.log("can-redo - N", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

      UndoEngine.undo();
      console.log("UNDO");
      console.log("can-undo - Y", UndoEngine.canUndo());
      console.log("can-redo - Y", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

      UndoEngine.undo();
      console.log("UNDO");
      console.log("can-undo - N", UndoEngine.canUndo());
      console.log("can-redo - Y", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

      UndoEngine.redo();
      console.log("REDO");
      console.log("can-undo - Y", UndoEngine.canUndo());
      console.log("can-redo - Y", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

      UndoEngine.redo();
      console.log("REDO");
      console.log("can-undo - Y", UndoEngine.canUndo());
      console.log("can-redo - N", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

      UndoEngine.undo();
      console.log("UNDO");
      console.log("can-undo - Y", UndoEngine.canUndo());
      console.log("can-redo - Y", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

      UndoEngine.undo();
      console.log("UNDO");
      console.log("can-undo - N", UndoEngine.canUndo());
      console.log("can-redo - Y", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

      try {
        UndoEngine.undo();
        console.log("UNDO");
        console.log("can-undo - N", UndoEngine.canUndo());
        console.log("can-redo - Y", UndoEngine.canRedo());
        console.log("Undo list", UndoEngine.listU());
      } catch(err) {
        console.log('Error:', err);
      }

      UndoEngine.redo();
      console.log("REDO");
      console.log("can-undo - Y", UndoEngine.canUndo());
      console.log("can-redo - Y", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

      UndoEngine.addCommand({action: "rotate", object_definition: "{Konva Rect ...}", executeUndo() {console.log('undoing rotate'); }, executeRedo() { console.log('redo rotate'); } });
      console.log("ROTATED");
      console.log("can-undo - Y", UndoEngine.canUndo());
      console.log("can-redo - N", UndoEngine.canRedo());
      console.log("Undo list", UndoEngine.listU());

    </script>
  </body>

</html>
